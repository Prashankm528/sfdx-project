<aura:component implements="flexipage:availableForAllPageTypes,force:appHostable" controller="CAIDP_ManageUsersController">

  <aura:attribute type="String" name="userEmail" default=""/>
  <aura:attribute type="Boolean[]" name="checkboxes" default="[false, false, false]"/>
  <aura:attribute type="List" name="members" default="[]"/>
  <aura:attribute type="List" name="membersPreview" default="[]"/>
  <aura:attribute type="List" name="allMembers" default="[]"/>
  <aura:attribute type="String" name="memberCount" default="0"/>
  <aura:attribute type="List" name="castrolApps" default="[]"/>
  <aura:attribute name="fileToBeUploaded" type="Object[]"/>
  <aura:attribute name="languages" type="List" />

  <aura:attribute type="Boolean" name="isOpen" default="false" />
  <aura:attribute type="Boolean" name="isResizing" default="false" />
  <aura:attribute type="Boolean" name="isUpload" default="false" />
  <aura:attribute type="Boolean" name="isSent" default="false" />
  <aura:attribute type="Boolean" name="isFileSelected" default="false" />
  <aura:attribute type="Boolean" name="isPreview" default="false" />
  <aura:attribute type="Boolean" name="invited" default="false" />
  <aura:attribute type="Datetime" name="invitedDate" default="" />
  <aura:attribute type="String" name="modalHeader" default=""/>
  <aura:attribute type="String" name="modalMessage" default=""/>
  <aura:attribute type="String" name="fileTitle" default=""/>
  <aura:attribute type="String" name="fileUrl" default=""/>
  <aura:attribute type="String" name="uploadLabel" default=""/>
  <aura:attribute type="String" name="jsonMembers" default=""/>
  <aura:attribute type="String" name="rows" default="1"/>

  <aura:attribute type="Integer" name="pageNumber" default="1" />
  <aura:attribute type="Integer" name="maxPage" default="1" />
  <aura:attribute type="Integer" name="pageSize" default="10" />

  <aura:handler event="aura:waiting" action="{!c.toggleSpinner}"/>
  <aura:handler event="aura:doneWaiting" action="{!c.toggleSpinner}"/>

	<aura:handler name="init" action="{!c.doInit}" value="{!this}" />  
  <aura:handler name="change" action="{!c.renderPage}" value="{!v.pageNumber}"/>

  <div class="slds">    
    <div class="slds-grid slds-grid_vertical-stretch">
    <article class="slds-card">
      <div class="slds-card__header slds-grid">
        <header class="slds-media slds-media_center slds-has-flexi-truncate">
         <div class="slds-media__figure">
            <span class="slds-icon_container slds-icon-standard-user">
              <lightning:icon iconName="action:user" variant="user"/>
            </span>
          </div>
          <div class="slds-media__body">
            <h2>
              <a href="javascript:void(0);" class="slds-card__header-link slds-truncate">
                <span class="slds-text-heading_small">Invite Users to Castrol</span>
              </a>
            </h2>
          </div>
          <div class="slds-button-group slds-align_absolute-center" role="group">
            <lightning:button variant="neutral" label="Upload Users" onclick="{!c.openUpload}" />
            <lightning:button variant="neutral" label="Resize" onclick="{!c.openResize}" />
            <lightning:button variant="neutral" label="Clear" onclick="{!c.doInit}" />
          </div>&nbsp;&nbsp;&nbsp;&nbsp;
          <div class="slds-no-flex">
            <lightning:button variant="brand" label="Invite" onclick="{!c.inviteUsers}" />
            <lightning:button variant="brand" label="Migrate" onclick="{!c.migrateUsers}" />
          </div>
        </header>
      </div>
      <div class="slds-card__body">
        <lightning:spinner variant="brand" size="large" aura:id="mySpinner" class="slds-hide"/>
        <aura:if isTrue="{!v.invited}">
          <div class="slds-notify slds-notify_alert slds-theme_alert-texture slds-theme_warning" role="alert">
            <span class="slds-icon_container slds-icon-utility-warning slds-m-right_x-small">
              <lightning:icon iconName="utility:warning" variant="warning" size="small"/>
            </span>
            <h2>Following users have been invited on&nbsp;
              <lightning:formattedDateTime value="{!v.invitedDate}" year="numeric" month="short" day="2-digit" hour="2-digit" minute="2-digit"/>
            </h2>
            <button class="slds-button slds-button_icon slds-notify__close slds-button_icon-inverse" title="Close" onclick="{!c.closeAlert}">
              <lightning:icon iconName="utility:close" variant="close"/>
              <span class="slds-assistive-text">Close</span>
            </button>
          </div>
        </aura:if>
        <table class="slds-table slds-table_fixed-layout slds-table_bordered slds-table_cell-buffer">
          <thead>
            <tr class="slds-text-title_caps">
              <th scope="col">
                <div class="slds-truncate" title="Email">Email</div>
              </th>
              <th scope="col">
                <div class="slds-truncate" title="Language">Language</div>
              </th>
              <aura:iteration items="{!v.castrolApps}" var="castrolApp">
                <th scope="col">
                  <div class="slds-truncate slds-align_absolute-center">{!castrolApp.label}</div>
                </th>
              </aura:iteration>
            </tr>
          </thead>
          <tbody>
            <aura:iteration items="{!v.members}" var="member" indexVar="row">
              <tr class="slds-hint-parent">
                <td>
                  <div class="slds-form-element ">
                    <div class="slds-form-element__control">
                      <lightning:input type="email" name="Email" placeholder="Email" value="{!member.email}"/>
                    </div>
                  </div>
                </td>
                <td>
                  <div class="slds-form-element ">
                    <div class="slds-form-element__control">
                      <lightning:select name="languageSelect" aura:id="languageSelect" value="{!member.language}">
                          <aura:iteration items="{!v.languages}" var="item">
                              <option text="{!item.label}" value="{!item.value}" selected="{!item.selected}"/>
                           </aura:iteration>
                      </lightning:select>
                    </div>
                  </div>
                </td>
                <aura:iteration items="{!member.apps}" var="app" indexVar="index">
                  <td>
                    <div class="slds-checkbox_add-button slds-align_absolute-center">
                      <lightning:input value="{!row + '-' + index}" type="checkbox-button" checked="{!app.enabled}" disabled="{!app.autoAssigned}"/>
                    </div>
                  </td>
                </aura:iteration>
              </tr>
            </aura:iteration>
          </tbody>
        </table>
      </div>
      <footer class="slds-card__footer">
        <div class="slds-button-group slds-align_absolute-center" role="group">
          <button class="slds-button slds-button_neutral" onclick="{!c.firstPage}" disabled="{!v.pageNumber == 1}">First</button>
          <button class="slds-button slds-button_icon slds-button--icon-border" title="Previous" onclick="{!c.prevPage}" disabled="{!v.pageNumber == 1}">
            <lightning:icon iconName="utility:chevronleft" variant="chevronleft" size="x-small"/>
            <span class="slds-assistive-text">Previous</span>
          </button>
          <button class="slds-button slds-button_neutral" title="Page">
            <span class="slds-assistive-text">Page</span>
            {!v.pageNumber}/{!v.maxPage}
          </button>
          <button class="slds-button slds-button_icon slds-button--icon-border" title="Next" onclick="{!c.nextPage}" disabled="{!v.pageNumber == v.maxPage}">
            <lightning:icon iconName="utility:chevronright" variant="chevronright" size="x-small" class="slds-button__icon"/>
            <span class="slds-assistive-text">Next</span>
          </button>
          <button class="slds-button slds-button_neutral" onclick="{!c.lastPage}" disabled="{!v.pageNumber == v.maxPage}">Last</button>
        </div>
        <div class="slds-no-flex">
          <lightning:button variant="brand" label="Invite" onclick="{!c.inviteUsers}" />
          <lightning:button variant="brand" label="Migrate" onclick="{!c.migrateUsers}" />
        </div>
      </footer>
    </article>
    <aura:if isTrue="{!v.isOpen}">
        <section role="dialog" tabindex="-1" aria-labelledby="modal-heading-01" aria-modal="true" aria-describedby="modal-content-id-1" class="slds-modal slds-fade-in-open slds-size_2-of-5 slds-align_absolute-center">
          <div class="slds-modal__container">
            <header class="slds-modal__header">
              <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" title="Close" onclick="{!c.closeModal}">
                <lightning:icon iconName="utility:close" variant="close"/>
                <span class="slds-assistive-text">Close</span>
              </button>
              <h2 id="modal-heading-01" class="slds-text-heading_medium slds-hyphenate">{!v.modalHeader}</h2>
            </header>
            <aura:if isTrue="{!!v.isSent}">
                <div class="slds-notify slds-notify_alert slds-theme_alert-texture slds-theme_error" role="alert">
                    <p style="font-size: 1.2rem;">{!v.modalMessage}</p>
                </div>
            </aura:if>
            <aura:if isTrue="{!v.isSent}">
                <div class="slds-notify slds-notify_alert slds-theme_alert-texture slds-theme_success" role="alert">
                    <p style="font-size: 1.2rem;">{!v.modalMessage}</p>
                </div>
            </aura:if>
          </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open"></div>
    </aura:if>
    <aura:if isTrue="{!v.isResizing}">
        <section role="dialog" tabindex="-1" aria-labelledby="modal-heading-02" aria-modal="true" aria-describedby="modal-content-id-2" class="slds-modal slds-fade-in-open slds-size_2-of-5 slds-align_absolute-center">
          <div class="slds-modal__container">
            <header class="slds-modal__header slds-modal__header_empty">
              <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" title="Close" onclick="{!c.closeResize}">
                <lightning:icon iconName="utility:close" variant="close"/>
                <span class="slds-assistive-text">Close</span>
              </button>
            </header>
            <div class="slds-modal__content slds-p-around_medium" id="modal-content-id-2">
              <div class="slds-form-element">
                <label class="slds-form-element__label" for="text-input-id-2">Input number of rows:</label>
                <lightning:input type="number" value="{!v.rows}" min="1" max="100" step="1"/>
              </div>
            </div>
            <footer class="slds-modal__footer">
              <button class="slds-button slds-button_brand" onclick="{!c.resizeTable}" >Apply</button>
            </footer>
          </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open"></div>
    </aura:if>
    <aura:if isTrue="{!v.isUpload}">
      <section role="dialog" tabindex="-1" aria-labelledby="modal-heading-03" aria-modal="true" aria-describedby="modal-content-id-3" class="slds-modal slds-fade-in-open">
          <div class="slds-modal__container">
            <header class="slds-modal__header">
              <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" title="Close" onclick="{!c.closeUpload}">
                X
                <span class="slds-assistive-text">Close</span>
              </button>
              <h2 id="modal-heading-03" class="slds-text-heading_medium slds-hyphenate">{!v.uploadLabel}</h2>
            </header>
            <div class="slds-modal__content slds-p-around_medium" id="modal-content-id-3">
              <aura:if isTrue="{!!v.isFileSelected}">
                <lightning:input type="file" 
                  label="Select files" 
                  files="{!v.fileToBeUploaded}"
                  name="file" 
                  multiple="false" 
                  accept=".csv" 
                  messageWhenBadInput="File type not supported"
                  onchange="{!c.upload}"/>
                <aura:set attribute="else">
                  <div style="width: 20rem;">
                    <div class="slds-file slds-file_card">
                      <figure>
                        <a onclick="{!c.openPreview}" name="{!v.fileTitle}" class="slds-file__crop">
                          <span class="slds-file__icon slds-icon_container">
                            <lightning:icon iconName="doctype:csv" variant="csv"/>
                            <span class="slds-assistive-text">{!v.fileTitle}</span>
                          </span>
                        </a>
                        <figcaption class="slds-file__title slds-file__title_card">
                          <div class="slds-media slds-media_small slds-media_center">
                            <div class="slds-media__figure slds-line-height_reset">
                              <span class="slds-icon_container">
                                <lightning:icon iconName="doctype:csv" variant="csv"/>
                                <span class="slds-assistive-text">{!v.fileTitle}</span>
                              </span>
                            </div>
                            <div class="slds-media__body">
                              <span class="slds-file__text slds-truncate">{!v.fileTitle}</span>
                            </div>
                          </div>
                        </figcaption>
                      </figure>
                    </div>
                  </div>
                </aura:set>
              </aura:if>
            </div>
            <footer class="slds-modal__footer">
              <button class="slds-button slds-button_neutral" onclick="{!c.closeUpload}" >Cancel</button>
              <button class="slds-button slds-button_neutral" onclick="{!c.uploadUsers}" >Upload</button>
            </footer>
          </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open"></div>
    </aura:if>
    <aura:if isTrue="{!v.isPreview}">
        <section role="dialog" tabindex="-1" aria-labelledby="modal-heading-04" aria-modal="true" aria-describedby="modal-content-id-4" class="slds-modal slds-fade-in-open slds-modal_medium">
          <div class="slds-modal__container">
            <header class="slds-modal__header">
              <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" title="Close" onclick="{!c.closePreview}">
                X
                <span class="slds-assistive-text">Close</span>
              </button>
              <h2 id="modal-heading-04" class="slds-text-heading_medium slds-hyphenate">{!v.fileTitle}</h2>
            </header>
            <div class="slds-modal__content slds-p-around_medium" id="modal-content-id-4">
              <table class="slds-table slds-table_bordered slds-table_cell-buffer slds-no-row-hover">
                <thead>
                  <tr class="slds-text-title_caps">
                    <th scope="col">
                      <div class="slds-truncate" title="Email">Email</div>
                    </th>
                    <th scope="col">
                      <div class="slds-truncate" title="Language">Language</div>
                    </th>
                    <th scope="col">
                      <div class="slds-truncate" title="Apps">Apps</div>
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <aura:iteration items="{!v.membersPreview}" var="member">
                    <tr>
                      <th scope="row" data-label="Email">
                        <div class="slds-truncate"><a href="javascript:void(0);">{!member.email}</a></div>
                      </th>
                      <td data-label="Language">
                        <div class="slds-truncate">{!member.language}</div>
                      </td>
                      <td data-label="Apps">
                        <div class="slds-truncate">
                          <aura:iteration items="{!member.apps}" var="app">
                            <aura:if isTrue="{!app.enabled}">
                              {!app.label}&nbsp; 
                            </aura:if>
                          </aura:iteration>
                        </div>
                      </td>
                    </tr>
                  </aura:iteration>
                </tbody>
              </table>
            </div>
<!--             <footer class="slds-modal__footer">
              <button class="slds-button slds-button_brand" onclick="{!c.closePreview}" >Close</button>
            </footer> -->
          </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open"></div>
    </aura:if>
    </div>
  </div> 
</aura:component>